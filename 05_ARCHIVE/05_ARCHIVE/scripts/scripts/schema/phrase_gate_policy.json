{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "https://k4/schema/phrase_gate_policy.json",
  "type": "object",
  "additionalProperties": false,
  "required": [
    "schema_version",
    "combine",
    "tokenization",
    "window",
    "flint_v2",
    "generic",
    "cadence_ref"
  ],
  "properties": {
    "schema_version": {"type": "string", "enum": ["1.0.0"]},
    "combine": {"type": "string", "enum": ["AND", "OR"]},
    "tokenization": {"type": "string", "enum": ["v2"]},
    "window": {
      "type": "array",
      "items": {"type": "integer", "minimum": 0},
      "minItems": 2,
      "maxItems": 2,
      "$comment": "Token window [start,end]"
    },
    "flint_v2": {
      "type": "object",
      "additionalProperties": false,
      "required": [
        "declination_patterns",
        "instrument_verbs",
        "directions",
        "instrument_nouns",
        "min_content",
        "max_repeat"
      ],
      "properties": {
        "declination_patterns": {"type": "array", "items": {"type": "string"}},
        "instrument_verbs": {"type": "array", "items": {"type": "string"}},
        "directions": {"type": "array", "items": {"type": "string"}},
        "instrument_nouns": {"type": "array", "items": {"type": "string"}},
        "min_content": {"type": "integer", "minimum": 0},
        "max_repeat": {"type": "integer", "minimum": 0}
      }
    },
    "generic": {
      "type": "object",
      "additionalProperties": false,
      "required": ["perplexity_top_percent", "pos_threshold", "calibration_hashes"],
      "properties": {
        "perplexity_top_percent": {"type": "number", "enum": [0.5, 1.0, 1.5]},
        "pos_threshold": {"type": "number", "enum": [0.55, 0.60, 0.65]},
        "calibration_hashes": {
          "type": "object",
          "additionalProperties": false,
          "required": ["perplexity", "pos_trigrams", "pos_threshold"],
          "properties": {
            "perplexity": {"type": "string", "pattern": "^[a-f0-9]{64}$"},
            "pos_trigrams": {"type": "string", "pattern": "^[a-f0-9]{64}$"},
            "pos_threshold": {"type": "string", "pattern": "^[a-f0-9]{64}$"}
          }
        }
      }
    },
    "cadence_ref": {
      "type": "object",
      "additionalProperties": false,
      "required": ["policy_sha256", "thresholds_sha256"],
      "properties": {
        "policy_sha256": {"type": "string", "pattern": "^[a-f0-9]{64}$"},
        "thresholds_sha256": {"type": "string", "pattern": "^[a-f0-9]{64}$"}
      }
    }
  }
}
